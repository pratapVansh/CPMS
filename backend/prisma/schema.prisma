// Prisma schema for CPMS

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// Enums
enum Role {
  SUPER_ADMIN
  ADMIN
  STUDENT
}

enum UserStatus {
  ACTIVE
  DISABLED
}

enum ApplicationStatus {
  APPLIED
  SHORTLISTED
  REJECTED
  SELECTED
}

// Models
model User {
  id            String         @id @default(uuid())
  name          String
  email         String         @unique
  password      String
  role          Role           @default(STUDENT)
  status        UserStatus     @default(ACTIVE)
  cgpa          Float?
  branch        String?
  currentYear   Int?
  currentSemester Int?
  createdBy     String?
  createdAt     DateTime       @default(now())
  updatedAt     DateTime       @updatedAt

  // Student document fields (Cloudinary)
  resumePublicId     String?
  resumeUrl          String?
  marksheetPublicId  String?
  marksheetUrl       String?

  applications  Application[]
  resume        Resume?
  refreshTokens RefreshToken[]
  auditLogs     AuditLog[]

  @@index([email])
  @@index([role])
  @@index([status])
}

model AuditLog {
  id        String   @id @default(uuid())
  userId    String
  action    String
  target    String?
  meta      Json?
  ip        String?
  createdAt DateTime @default(now())

  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([action])
  @@index([createdAt])
}

model Company {
  id              String        @id @default(uuid())
  name            String
  roleOffered     String
  minCgpa         Float
  allowedBranches String[]
  allowedYears    Int[]
  deadline        DateTime
  createdAt       DateTime      @default(now())
  updatedAt       DateTime      @updatedAt

  applications    Application[]

  @@index([deadline])
}

model Application {
  id        String            @id @default(uuid())
  studentId String
  companyId String
  status    ApplicationStatus @default(APPLIED)
  createdAt DateTime          @default(now())
  updatedAt DateTime          @updatedAt

  student   User              @relation(fields: [studentId], references: [id], onDelete: Cascade)
  company   Company           @relation(fields: [companyId], references: [id], onDelete: Cascade)

  @@unique([studentId, companyId])
  @@index([studentId])
  @@index([companyId])
  @@index([status])
}

model Resume {
  id        String   @id @default(uuid())
  userId    String   @unique
  url       String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model RefreshToken {
  id        String   @id @default(uuid())
  token     String   @unique
  userId    String
  expiresAt DateTime
  createdAt DateTime @default(now())

  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([expiresAt])
}
